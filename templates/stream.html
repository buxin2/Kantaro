<!-- templates/stream.html -->
{% extends "base.html" %}

{% block title %}{{ camera.name }} - Live Stream{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>{{ camera.name }} - Live Stream</h2>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
        </div>
        
        <div class="card">
            <div class="card-body text-center">
                {% if camera.camera_type == 'device' %}
                <video id="webcam" autoplay playsinline class="img-fluid" style="max-width: 100%; height: auto;"></video>
                <canvas id="overlay" class="d-none"></canvas>
                <div class="mt-3">
                    <button id="toggle-detect" class="btn btn-primary btn-sm">Enable Detection</button>
                    <button id="start-broadcast" class="btn btn-success btn-sm">Start Broadcast</button>
                    <a href="{{ url_for('watch_stream', camera_id=camera.id) }}" target="_blank" class="btn btn-outline-secondary btn-sm">Open Watch Page</a>
                    <a href="{{ url_for('start_monitor', camera_id=camera.id) }}" class="btn btn-warning btn-sm">Start Monitor</a>
                    <a href="{{ url_for('stop_monitor', camera_id=camera.id) }}" class="btn btn-outline-warning btn-sm">Stop Monitor</a>
                </div>
                {% else %}
                <img src="{{ url_for('video', camera_id=camera.id) }}" class="img-fluid" style="max-width: 100%; height: auto;">
                {% endif %}
            </div>
        </div>
        
        <div class="mt-3">
            <small class="text-muted">
                Camera Type: {{ camera.camera_type.upper() }}
                {% if camera.camera_url %}
                | URL: {{ camera.camera_url }}
                {% endif %}
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if camera.camera_type == 'device' %}
<script>
const videoEl = document.getElementById('webcam');
const canvasEl = document.getElementById('overlay');
const toggleBtn = document.getElementById('toggle-detect');
const broadcastBtn = document.getElementById('start-broadcast');
let sending = false;
let detectionEnabled = false;
let broadcastEnabled = false;

async function initWebcam() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 960, height: 540 }, audio: false });
    videoEl.srcObject = stream;
  } catch (e) {
    console.error('Webcam init failed', e);
    alert('Unable to access your camera. Please allow camera permission.');
  }
}

async function sendFrame() {
  if (!detectionEnabled || sending) return;
  sending = true;
  try {
    const w = videoEl.videoWidth || 960;
    const h = videoEl.videoHeight || 540;
    canvasEl.width = w; canvasEl.height = h;
    const ctx = canvasEl.getContext('2d');
    ctx.drawImage(videoEl, 0, 0, w, h);
    const blob = await new Promise(r => canvasEl.toBlob(r, 'image/jpeg', 0.8));
    const form = new FormData();
    form.append('frame', blob, 'frame.jpg');
    const res = await fetch('{{ url_for('analyze_frame', camera_id=camera.id) }}', { method: 'POST', body: form });
    if (res.ok) {
      const blobOut = await res.blob();
      const url = URL.createObjectURL(blobOut);
      videoEl.srcObject = null;
      videoEl.src = url;
    }
  } catch (e) {
    console.error('Send frame failed', e);
  } finally {
    sending = false;
  }
}

toggleBtn.addEventListener('click', () => {
  detectionEnabled = !detectionEnabled;
  toggleBtn.textContent = detectionEnabled ? 'Disable Detection' : 'Enable Detection';
});

initWebcam();
setInterval(sendFrame, 100); // ~10 FPS

broadcastBtn.addEventListener('click', () => {
  broadcastEnabled = !broadcastEnabled;
  broadcastBtn.textContent = broadcastEnabled ? 'Stop Broadcast' : 'Start Broadcast';
});

async function pushFrame() {
  if (!broadcastEnabled) return;
  try {
    const w = videoEl.videoWidth || 960;
    const h = videoEl.videoHeight || 540;
    canvasEl.width = w; canvasEl.height = h;
    const ctx = canvasEl.getContext('2d');
    ctx.drawImage(videoEl, 0, 0, w, h);
    const blob = await new Promise(r => canvasEl.toBlob(r, 'image/jpeg', 0.8));
    const form = new FormData();
    form.append('frame', blob, 'frame.jpg');
    await fetch('{{ url_for('push_frame', camera_id=camera.id) }}', { method: 'POST', body: form });
  } catch (e) {
    console.error('Push frame failed', e);
  }
}

setInterval(pushFrame, 66); // ~15 FPS broadcast
</script>
{% endif %}
{% endblock %}